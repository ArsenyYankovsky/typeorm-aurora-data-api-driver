version: 2
jobs:
  checks:
    docker:
      - image: 'circleci/node:latest'
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: lint
          command: yarn lint
      - run:
          name: test
          command: yarn test:unit

  release:
    docker:
      - image: 'circleci/node:latest'
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: release
          command: yarn semantic-release || true

  functional-test:
    docker:
      - image: 'circleci/node:latest'
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: create link
          command: npm link --unsafe-perm
      - run:
          name: checkout typeorm
          command: git clone --single-branch --branch feature/aurora-data-api https://github.com/ArsenyYankovsky/typeorm.git #TODO: change to checkout master once PR is merged
      - run:
          name: build typeorm with current package
          command: cd typeorm/ && npm i && npm link typeorm-aurora-data-api --unsafe-perm && ../dist && npm run package
      - run:
          name: run functional test
          command: cd ../ && npm i aws-sdk && yarn test:func

workflows:
  version: 2
  release:
    jobs:
      - checks:
          filters:
            branches:
              only:
                - master
      - release:
          filters:
            branches:
              only:
                - master
          requires:
            - checks
  check-commit:
    jobs:
      - checks
      - functional-test:
          requires:
            - checks
