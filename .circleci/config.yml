version: 2
jobs:
  checks:
    docker:
      - image: "node:latest"
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: lint
          command: yarn lint
      - run:
          name: test
          command: yarn test:unit

  release:
    docker:
      - image: "circleci/node:latest"
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: build
          command: yarn build
      - run:
          name: release
          command: yarn semantic-release || true

  prepare-functional-test-released:
    docker:
      - image: "node:latest"
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: install additional dependencies
          command: yarn add typeorm aws-sdk typeorm-aurora-data-api-driver
      - persist_to_workspace:
          root: .
          paths:
            - .

  prepare-functional-test:
    docker:
      - image: "node:latest"
    steps:
      - checkout
      - run:
          name: yarn
          command: yarn
      - run:
          name: build
          command: yarn build
      - run:
          name: create link
          command: npm link
      - run:
          name: checkout typeorm
          command: git clone --single-branch --branch master https://github.com/typeorm/typeorm.git
      - run:
          name: build typeorm with current package
          command: cd typeorm/ && npm i && npm run package && cd build/package && npm link && rm -rf node_modules/typeorm-aurora-data-api-driver && npm link typeorm-aurora-data-api-driver
      - run:
          name: link built typeorm
          command: npm i aws-sdk && npm link typeorm
      - persist_to_workspace:
          root: .
          paths:
            - .

  run-mysql-func-tests:
    docker:
      - image: "circleci/node:latest"
    steps:
      - attach_workspace:
          at: .
      - setup_remote_docker
      - run:
        name: start local mysql
        command: docker-compose -f docker/mysql.yml up -d
      - run:
          name: run mysql functional test
          command: yarn test:mysql-func

  run-pg-func-tests:
    docker:
      - image: "circleci/node:latest"
    steps:
      - attach_workspace:
          at: .
      - setup_remote_docker
      - run:
          name: start local mysql
          command: docker-compose -f docker/pg.yml up -d
      - run:
          name: run mysql functional test
          command: yarn test:pg-func

workflows:
  version: 2
  release:
    jobs:
      - checks:
          filters:
            branches:
              only:
                - master
      - prepare-functional-test:
          filters:
            branches:
              only:
                - master
          requires:
            - checks
      - run-mysql-func-tests:
          filters:
            branches:
              only:
                - master
          requires:
            - prepare-functional-test
      - run-pg-func-tests:
          filters:
            branches:
              only:
                - master
          requires:
            - prepare-functional-test
      - release:
          filters:
            branches:
              only:
                - master
          requires:
            - run-pg-func-tests
            - run-mysql-func-tests

  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - checks:
          filters:
            branches:
              only:
                - master
      - prepare-functional-test-released:
          filters:
            branches:
              only:
                - master
          requires:
            - checks
      - run-mysql-func-tests:
          filters:
            branches:
              only:
                - master
          requires:
            - prepare-functional-test-released
      - run-pg-func-tests:
          filters:
            branches:
              only:
                - master
          requires:
            - prepare-functional-test-released

  check-commit:
    jobs:
      - checks
      - prepare-functional-test:
          requires:
            - checks
      - run-mysql-func-tests:
          requires:
            - prepare-functional-test
      - run-pg-func-tests:
          requires:
            - prepare-functional-test
